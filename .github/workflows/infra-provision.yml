name: infra-provision

on:
  workflow_dispatch:

env:
  SUBSCRIPTION_ID: "14bcc9f5-e7a6-42aa-906f-c0ae9c69d8b3"
  RESOURCE_GROUP: "dual-language-audio-reader"
  LOCATION: "westeurope"
  ACR_NAME: "duallanguageaudioacr"
  CONTAINERAPP_ENV: "dual-language-audio-reader-env"
  CONTAINERAPP_NAME: "dl-audio-reader"
  IMAGE_NAME: "dual-language-audio-reader"
  AOAI_NAME: "dual-language-audio-reader-open-ai-gpt-4o-mini"
  AOAI_DEPLOYMENT: "gpt-4o-mini"
  AOAI_MODEL: "gpt-4o-mini"
  AOAI_MODEL_VERSION: "2024-07-18"
  AOAI_API_VERSION: "2024-02-15-preview"

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Provision and Deploy
        shell: bash
        run: |
          set -euo pipefail

          az account set --subscription "$SUBSCRIPTION_ID"
          az provider register -n Microsoft.App --wait
          az provider register -n Microsoft.OperationalInsights --wait
          az provider register -n Microsoft.CognitiveServices --wait

          az group create --name "$RESOURCE_GROUP" --location "$LOCATION"

          if ! az cognitiveservices account show --name "$AOAI_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az cognitiveservices account create --name "$AOAI_NAME" --resource-group "$RESOURCE_GROUP" --kind OpenAI --sku S0 --location "$LOCATION" --yes
          fi

          if ! az cognitiveservices account deployment show --name "$AOAI_NAME" --resource-group "$RESOURCE_GROUP" --deployment-name "$AOAI_DEPLOYMENT" >/dev/null 2>&1; then
            az cognitiveservices account deployment create --name "$AOAI_NAME" --resource-group "$RESOURCE_GROUP" --deployment-name "$AOAI_DEPLOYMENT" --model-name "$AOAI_MODEL" --model-version "$AOAI_MODEL_VERSION" --model-format OpenAI
          fi

          AOAI_ENDPOINT=$(az cognitiveservices account show --name "$AOAI_NAME" --resource-group "$RESOURCE_GROUP" --query properties.endpoint -o tsv)
          AOAI_KEY=$(az cognitiveservices account keys list --name "$AOAI_NAME" --resource-group "$RESOURCE_GROUP" --query key1 -o tsv)

          if ! az acr show --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az acr create --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP" --sku Basic --admin-enabled true
          else
            az acr update --name "$ACR_NAME" --admin-enabled true
          fi

          ACR_LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP" --query loginServer -o tsv)
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)
          IMAGE_TAG=${GITHUB_SHA::7}

          echo "$ACR_PASSWORD" | docker login "$ACR_LOGIN_SERVER" -u "$ACR_USERNAME" --password-stdin

          docker build -t "$IMAGE_NAME:$IMAGE_TAG" .
          docker tag "$IMAGE_NAME:$IMAGE_TAG" "$ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG"
          docker push "$ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG"

          if ! az containerapp env show --name "$CONTAINERAPP_ENV" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az containerapp env create --name "$CONTAINERAPP_ENV" --resource-group "$RESOURCE_GROUP" --location "$LOCATION"
          fi

          if az containerapp show --name "$CONTAINERAPP_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az containerapp update \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --image "$ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG" \
              --secrets aoai-key=$AOAI_KEY \
              --set-env-vars AZURE_OPENAI_ENDPOINT=$AOAI_ENDPOINT AZURE_OPENAI_DEPLOYMENT=$AOAI_DEPLOYMENT AZURE_OPENAI_API_VERSION=$AOAI_API_VERSION AZURE_OPENAI_API_KEY=secretref:aoai-key
          else
            az containerapp create \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINERAPP_ENV" \
              --image "$ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG" \
              --registry-server "$ACR_LOGIN_SERVER" \
              --registry-username "$ACR_USERNAME" \
              --registry-password "$ACR_PASSWORD" \
              --secrets aoai-key=$AOAI_KEY \
              --env-vars AZURE_OPENAI_ENDPOINT=$AOAI_ENDPOINT AZURE_OPENAI_DEPLOYMENT=$AOAI_DEPLOYMENT AZURE_OPENAI_API_VERSION=$AOAI_API_VERSION AZURE_OPENAI_API_KEY=secretref:aoai-key \
              --ingress external \
              --target-port 8080 \
              --min-replicas 0 \
              --max-replicas 1
          fi

          az containerapp show --name "$CONTAINERAPP_NAME" --resource-group "$RESOURCE_GROUP" --query properties.configuration.ingress.fqdn -o tsv

