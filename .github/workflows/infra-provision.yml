name: infra-provision

on:
  workflow_dispatch:

env:
  SUBSCRIPTION_ID: "14bcc9f5-e7a6-42aa-906f-c0ae9c69d8b3"
  RESOURCE_GROUP: "dual-language-audio-reader"
  LOCATION: "westeurope"
  ACR_NAME: "duallanguageaudioacr"
  CONTAINERAPP_ENV: "dual-language-audio-reader-env"
  CONTAINERAPP_NAME: "dl-audio-reader"
  IMAGE_NAME: "dual-language-audio-reader"

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Provision and Deploy
        shell: bash
        run: |
          set -euo pipefail

          az account set --subscription "$SUBSCRIPTION_ID"
          az provider register -n Microsoft.App --wait
          az provider register -n Microsoft.OperationalInsights --wait

          az group create --name "$RESOURCE_GROUP" --location "$LOCATION"

          if ! az acr show --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az acr create --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP" --sku Basic --admin-enabled true
          else
            az acr update --name "$ACR_NAME" --admin-enabled true
          fi

          ACR_LOGIN_SERVER=$(az acr show --name "$ACR_NAME" --resource-group "$RESOURCE_GROUP" --query loginServer -o tsv)
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)

          echo "$ACR_PASSWORD" | docker login "$ACR_LOGIN_SERVER" -u "$ACR_USERNAME" --password-stdin

          docker build -t "$IMAGE_NAME:latest" .
          docker tag "$IMAGE_NAME:latest" "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest"
          docker push "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest"

          if ! az containerapp env show --name "$CONTAINERAPP_ENV" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az containerapp env create --name "$CONTAINERAPP_ENV" --resource-group "$RESOURCE_GROUP" --location "$LOCATION"
          fi

          if az containerapp show --name "$CONTAINERAPP_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            az containerapp update \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --image "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest"
          else
            az containerapp create \
              --name "$CONTAINERAPP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINERAPP_ENV" \
              --image "$ACR_LOGIN_SERVER/$IMAGE_NAME:latest" \
              --registry-server "$ACR_LOGIN_SERVER" \
              --registry-username "$ACR_USERNAME" \
              --registry-password "$ACR_PASSWORD" \
              --ingress external \
              --target-port 8080 \
              --min-replicas 0 \
              --max-replicas 1
          fi

          az containerapp show --name "$CONTAINERAPP_NAME" --resource-group "$RESOURCE_GROUP" --query properties.configuration.ingress.fqdn -o tsv
